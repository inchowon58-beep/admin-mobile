<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>관리자 발행량 설정</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; background: #f6f7f9; }
    .wrap { max-width: 520px; margin: 0 auto; padding: 16px; }
    .card { background: #fff; border-radius: 14px; padding: 14px; box-shadow: 0 6px 18px rgba(0,0,0,0.06); margin-bottom: 12px; }
    input, button { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #d7dbe0; font-size: 16px; box-sizing: border-box; }
    button { border: 0; background: #2f6fff; color: #fff; cursor: pointer; }
    button:disabled { background: #9fb9ff; cursor: not-allowed; }
    .row { display: grid; gap: 10px; }
    .muted { color: #6b7280; font-size: 13px; line-height: 1.4; }
    .ok { color: #0f7b3a; }
    .bad { color: #b42318; }
    .top { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 10px; }
    .tiny { font-size: 12px; color:#6b7280; word-break: break-all; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .hr { height:1px; background:#eef0f3; margin:10px 0; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <div>모바일 관리자</div>
          <div class="tiny" id="sessionInfo">로그인 안됨</div>
        </div>
        <button id="btnLogout" style="width:auto; padding:10px 12px; display:none;">로그아웃</button>
      </div>

      <div class="row" id="loginBox">
        <input id="email" type="email" placeholder="관리자 이메일" />
        <input id="password" type="password" placeholder="비밀번호" />
        <button id="btnLogin">로그인</button>
        <div class="muted">관리자 계정으로 Supabase Auth에 가입되어 있어야 합니다.</div>
        <div class="muted" id="loginMsg"></div>
      </div>
    </div>

    <div class="card" id="adminBox" style="display:none;">
      <div class="row">
        <input id="targetLoginId" placeholder="대상 로그인 아이디 입력 (예: infocs)" />
        <button id="btnApply30" disabled>발행량 전부 30 + 만료일 30일 연장</button>

        <div class="muted">
          적용 내용: daily_limit, tistory_daily_limit, cafe24_daily_limit, total_daily_limit = 30<br/>
          만료일: 남아있으면 기존 expires_at에서 +30일, 만료/없으면 오늘부터 +30일
        </div>

        <div class="muted" id="applyMsg"></div>

        <div class="hr"></div>

        <div class="muted mono" id="resultBox" style="white-space:pre-wrap;"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://kuoeuaueztytmebxjckn.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt1b2V1YXVlenR5dG1lYnhqY2tuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4Mjk2MDUsImV4cCI6MjA4MjQwNTYwNX0.J3N3RVUIa93-KNihGYAQnNCasy5L5rw5v5dmGDXtH80";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const el = (id) => document.getElementById(id);

    const sessionInfo = el("sessionInfo");
    const loginBox = el("loginBox");
    const adminBox = el("adminBox");
    const btnLogout = el("btnLogout");

    const btnLogin = el("btnLogin");
    const loginMsg = el("loginMsg");

    const targetLoginId = el("targetLoginId");
    const btnApply30 = el("btnApply30");
    const applyMsg = el("applyMsg");
    const resultBox = el("resultBox");

    function setMsg(node, text, type) {
      node.textContent = text || "";
      node.className = "muted " + (type || "");
    }

    function setResult(text) {
      resultBox.textContent = text || "";
    }

    async function refreshUI() {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        sessionInfo.textContent = "로그인됨: " + session.user.email;
        loginBox.style.display = "none";
        adminBox.style.display = "block";
        btnLogout.style.display = "inline-block";
      } else {
        sessionInfo.textContent = "로그인 안됨";
        loginBox.style.display = "grid";
        adminBox.style.display = "none";
        btnLogout.style.display = "none";
      }
    }

    btnLogin.addEventListener("click", async () => {
      setMsg(loginMsg, "");
      btnLogin.disabled = true;
      try {
        const email = el("email").value.trim();
        const password = el("password").value;
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
        setMsg(loginMsg, "로그인 성공", "ok");
        await refreshUI();
      } catch (e) {
        setMsg(loginMsg, "로그인 실패: " + (e?.message || e), "bad");
      } finally {
        btnLogin.disabled = false;
      }
    });

    btnLogout.addEventListener("click", async () => {
      await supabase.auth.signOut();
      await refreshUI();
    });

    targetLoginId.addEventListener("input", () => {
      btnApply30.disabled = targetLoginId.value.trim().length === 0;
    });

    async function fetchLicenseRow(loginId) {
      // license_limits.user_id 가 text(로그인아이디)인 구조라서 eq(user_id, loginId)
      const { data, error } = await supabase
        .from("license_limits")
        .select("user_id, daily_limit, tistory_daily_limit, cafe24_daily_limit, total_daily_limit, expires_at")
        .eq("user_id", loginId)
        .maybeSingle();

      if (error) throw error;
      if (!data) return null;
      return data;
    }

    btnApply30.addEventListener("click", async () => {
      setMsg(applyMsg, "");
      setResult("");
      btnApply30.disabled = true;

      try {
        const loginId = targetLoginId.value.trim();

        // ✅ 여기! UUID용 admin_set_limits_30 가 아니라
        // ✅ TEXT 아이디용 admin_set_limits_30_by_login_id 호출
        const { error } = await supabase.rpc("admin_set_limits_30_by_login_id", {
          p_login_id: loginId
        });
        if (error) throw error;

        setMsg(applyMsg, "적용 완료: " + loginId, "ok");

        // 적용 후 값 확인(바로 보여주기)
        const row = await fetchLicenseRow(loginId);
        if (!row) {
          setResult("license_limits에서 해당 아이디 행을 찾지 못했습니다: " + loginId);
        } else {
          setResult(
            "적용된 현재 값\n" +
            "user_id: " + row.user_id + "\n" +
            "daily_limit: " + row.daily_limit + "\n" +
            "tistory_daily_limit: " + row.tistory_daily_limit + "\n" +
            "cafe24_daily_limit: " + row.cafe24_daily_limit + "\n" +
            "total_daily_limit: " + row.total_daily_limit + "\n" +
            "expires_at: " + row.expires_at
          );
        }

      } catch (e) {
        setMsg(applyMsg, "적용 실패: " + (e?.message || e), "bad");
      } finally {
        btnApply30.disabled = false;
      }
    });

    supabase.auth.onAuthStateChange(() => refreshUI());
    refreshUI();
  </script>
</body>
</html>
