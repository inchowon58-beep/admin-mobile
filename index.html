<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>관리자 발행량 설정</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; background: #f6f7f9; }
    .wrap { max-width: 520px; margin: 0 auto; padding: 16px; }
    .card { background: #fff; border-radius: 14px; padding: 14px; box-shadow: 0 6px 18px rgba(0,0,0,0.06); margin-bottom: 12px; }
    input, button { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #d7dbe0; font-size: 16px; box-sizing: border-box; }
    button { border: 0; background: #2f6fff; color: #fff; cursor: pointer; }
    button:disabled { background: #9fb9ff; cursor: not-allowed; }
    .row { display: grid; gap: 10px; }
    .muted { color: #6b7280; font-size: 13px; line-height: 1.4; }
    .ok { color: #0f7b3a; }
    .bad { color: #b42318; }
    .top { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 10px; }
    .tiny { font-size: 12px; color:#6b7280; word-break: break-all; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <div>모바일 관리자</div>
          <div class="tiny" id="sessionInfo">로그인 안됨</div>
        </div>
        <button id="btnLogout" style="width:auto; padding:10px 12px; display:none;">로그아웃</button>
      </div>

      <div class="row" id="loginBox">
        <input id="email" type="email" placeholder="관리자 이메일" />
        <input id="password" type="password" placeholder="비밀번호" />
        <button id="btnLogin">로그인</button>
        <div class="muted">관리자 계정으로 Supabase Auth에 가입되어 있어야 합니다.</div>
        <div class="muted" id="loginMsg"></div>
      </div>

      <div class="row" id="resetBox" style="display:none;">
        <div class="muted">비밀번호 재설정 링크로 들어왔습니다. 새 비밀번호를 설정하세요.</div>
        <input id="newPassword" type="password" placeholder="새 비밀번호" />
        <input id="newPassword2" type="password" placeholder="새 비밀번호 확인" />
        <button id="btnSetPassword">비밀번호 저장</button>
        <div class="muted" id="resetMsg"></div>
      </div>
    </div>

    <div class="card" id="adminBox" style="display:none;">
      <div class="row">
        <input id="targetUserId" placeholder="대상 로그인 아이디 입력 (예: infocs)" />
        <button id="btnApply30" disabled>발행량 전부 30 + 만료일 30일 연장</button>
        <div class="muted">
          적용: daily_limit, tistory_daily_limit, cafe24_daily_limit, total_daily_limit = 30<br>
          만료일: 기존 expires_at이 남아있으면 거기서 +30일, 없으면 오늘부터 +30일
        </div>
        <div class="muted" id="applyMsg"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://kuoeuaueztytmebxjckn.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt1b2V1YXVlenR5dG1lYnhqY2tuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4Mjk2MDUsImV4cCI6MjA4MjQwNTYwNX0.J3N3RVUIa93-KNihGYAQnNCasy5L5rw5v5dmGDXtH80";

    const el = (id) => document.getElementById(id);

    const sessionInfo = el("sessionInfo");
    const loginBox = el("loginBox");
    const resetBox = el("resetBox");
    const adminBox = el("adminBox");
    const btnLogout = el("btnLogout");

    const btnLogin = el("btnLogin");
    const loginMsg = el("loginMsg");

    const btnSetPassword = el("btnSetPassword");
    const resetMsg = el("resetMsg");

    const targetUserId = el("targetUserId");
    const btnApply30 = el("btnApply30");
    const applyMsg = el("applyMsg");

    function setMsg(node, text, type) {
      node.textContent = text || "";
      node.className = "muted " + (type || "");
    }

    function isRecoveryLink() {
      const h = window.location.hash || "";
      const q = window.location.search || "";
      return h.includes("type=recovery") || q.includes("type=recovery");
    }

    // ✅ fetch 헤더에서 "라틴1 범위 밖 문자" 제거 (이 에러의 직접 해결)
    function toLatin1SafeString(v) {
      if (v == null) return "";
      const s = String(v);
      // fetch는 header value가 ByteString(대략 \x00-\xFF)이어야 함
      return s.replace(/[^\x00-\xFF]/g, "");
    }

    function sanitizeHeaders(initHeaders) {
      // initHeaders가 Headers | object | array 인 모든 케이스 처리
      const h = new Headers();

      try {
        const src = new Headers(initHeaders || {});
        for (const [k, v] of src.entries()) {
          const safeV = toLatin1SafeString(v);
          h.set(k, safeV);

          // 디버그: 혹시 뭘 잘라냈는지 확인 가능
          if (safeV !== String(v)) {
            console.warn("[header sanitized]", k, "before=", v, "after=", safeV);
          }
        }
      } catch (e) {
        // 혹시 initHeaders가 이상하게 들어오는 경우 대비
        console.warn("sanitizeHeaders fallback:", e);
      }

      return h;
    }

    async function safeFetch(url, options = {}) {
      const next = { ...options };
      next.headers = sanitizeHeaders(options.headers);

      // 혹시 URL/옵션에 이상값 있을 때 로그
      // console.log("safeFetch:", url, next);

      return fetch(url, next);
    }

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
      },
      global: {
        fetch: safeFetch, // ✅ 여기 핵심
      },
    });

    async function acceptSessionFromUrlIfAny() {
      try {
        // recovery/매직링크로 들어왔을 때 세션 저장
        await supabase.auth.getSessionFromUrl({ storeSession: true });
      } catch (e) {
        // 일부 케이스에서 예외가 날 수 있으니 무시
      }
    }

    async function refreshUI() {
      const { data: { session }, error } = await supabase.auth.getSession();
      if (error) console.warn("getSession error:", error);

      if (session) {
        sessionInfo.textContent = "로그인됨: " + session.user.email;
        btnLogout.style.display = "inline-block";

        if (isRecoveryLink()) {
          loginBox.style.display = "none";
          resetBox.style.display = "grid";
          adminBox.style.display = "none";
        } else {
          loginBox.style.display = "none";
          resetBox.style.display = "none";
          adminBox.style.display = "block";
        }
      } else {
        sessionInfo.textContent = "로그인 안됨";
        btnLogout.style.display = "none";
        loginBox.style.display = "grid";
        resetBox.style.display = "none";
        adminBox.style.display = "none";
      }
    }

    btnLogin.addEventListener("click", async () => {
      setMsg(loginMsg, "");
      btnLogin.disabled = true;

      try {
        const email = el("email").value.trim();
        const password = el("password").value; // 직접 입력값 그대로

        if (!email) throw new Error("이메일을 입력하세요.");
        if (!password) throw new Error("비밀번호를 입력하세요.");

        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;

        setMsg(loginMsg, "로그인 성공", "ok");
        await refreshUI();
      } catch (e) {
        console.log("LOGIN ERROR FULL:", e);
        setMsg(loginMsg, "로그인 실패: " + (e?.message || JSON.stringify(e) || e), "bad");
      } finally {
        btnLogin.disabled = false;
      }
    });

    btnSetPassword.addEventListener("click", async () => {
      setMsg(resetMsg, "");
      btnSetPassword.disabled = true;

      try {
        const p1 = el("newPassword").value;
        const p2 = el("newPassword2").value;

        if (!p1 || p1.length < 6) throw new Error("비밀번호는 6자 이상으로 입력하세요.");
        if (p1 !== p2) throw new Error("비밀번호 확인이 일치하지 않습니다.");

        const { error } = await supabase.auth.updateUser({ password: p1 });
        if (error) throw error;

        setMsg(resetMsg, "비밀번호 저장 완료. 이제 로그인 화면으로 이동합니다.", "ok");

        // URL 토큰 제거
        history.replaceState({}, document.title, window.location.pathname);

        await supabase.auth.signOut();
        await refreshUI();
      } catch (e) {
        console.log("RESET ERROR FULL:", e);
        setMsg(resetMsg, "비밀번호 저장 실패: " + (e?.message || JSON.stringify(e) || e), "bad");
      } finally {
        btnSetPassword.disabled = false;
      }
    });

    btnLogout.addEventListener("click", async () => {
      await supabase.auth.signOut();
      await refreshUI();
    });

    targetUserId.addEventListener("input", () => {
      btnApply30.disabled = targetUserId.value.trim().length === 0;
    });

    btnApply30.addEventListener("click", async () => {
      setMsg(applyMsg, "");
      btnApply30.disabled = true;

      try {
        const loginId = targetUserId.value.trim();
        const { error } = await supabase.rpc("admin_set_limits_30_by_login", { p_target_login: loginId });
        if (error) throw error;

        setMsg(applyMsg, "적용 완료: " + loginId, "ok");
      } catch (e) {
        console.log("APPLY ERROR FULL:", e);
        setMsg(applyMsg, "적용 실패: " + (e?.message || JSON.stringify(e) || e), "bad");
      } finally {
        btnApply30.disabled = false;
      }
    });

    supabase.auth.onAuthStateChange(() => refreshUI());

    await acceptSessionFromUrlIfAny();
    await refreshUI();
  </script>
</body>
</html>
