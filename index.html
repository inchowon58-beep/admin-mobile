<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>관리자 발행량 설정</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; background: #f6f7f9; }
    .wrap { max-width: 520px; margin: 0 auto; padding: 16px; }
    .card { background: #fff; border-radius: 14px; padding: 14px; box-shadow: 0 6px 18px rgba(0,0,0,0.06); margin-bottom: 12px; }
    input, button { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #d7dbe0; font-size: 16px; box-sizing: border-box; }
    button { border: 0; background: #2f6fff; color: #fff; cursor: pointer; }
    button:disabled { background: #9fb9ff; cursor: not-allowed; }
    .row { display: grid; gap: 10px; }
    .muted { color: #6b7280; font-size: 13px; line-height: 1.4; }
    .ok { color: #0f7b3a; }
    .bad { color: #b42318; }
    .top { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 10px; }
    .tiny { font-size: 12px; color:#6b7280; word-break: break-all; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <div>모바일 관리자</div>
          <div class="tiny" id="sessionInfo">로그인 안됨</div>
        </div>
        <button id="btnLogout" style="width:auto; padding:10px 12px; display:none;">로그아웃</button>
      </div>

      <div class="row" id="loginBox">
        <input id="email" type="email" placeholder="관리자 이메일" />
        <input id="password" type="password" placeholder="비밀번호" />
        <button id="btnLogin">로그인</button>
        <div class="muted">관리자 계정은 Supabase Auth에 존재해야 합니다.</div>
        <div class="muted" id="loginMsg"></div>
      </div>

      <div class="row" id="notAdminBox" style="display:none;">
        <div class="muted bad" id="notAdminMsg"></div>
      </div>
    </div>

    <div class="card" id="adminBox" style="display:none;">
      <div class="row">
        <input id="targetLogin" placeholder="대상 프로그램 아이디 입력 (예: infocs)" />
        <button id="btnApply30" disabled>발행량 30 + 사용가능일 30일 연장</button>
        <div class="muted">
          적용 내용 예시<br>
          daily_limit, tistory_daily_limit, cafe24_daily_limit, total_daily_limit = 30<br>
          expires_at: 기존 만료일이 남아있으면 거기서 +30일, 아니면 지금부터 +30일
        </div>
        <div class="muted" id="applyMsg"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://kuoeuaueztytmebxjckn.supabase.co";
    const SUPABASE_ANON_KEY = "여기에_anon_key";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const el = (id) => document.getElementById(id);

    const sessionInfo = el("sessionInfo");
    const loginBox = el("loginBox");
    const adminBox = el("adminBox");
    const notAdminBox = el("notAdminBox");
    const notAdminMsg = el("notAdminMsg");
    const btnLogout = el("btnLogout");

    const btnLogin = el("btnLogin");
    const loginMsg = el("loginMsg");

    const targetLogin = el("targetLogin");
    const btnApply30 = el("btnApply30");
    const applyMsg = el("applyMsg");

    function setMsg(node, text, type) {
      node.textContent = text || "";
      node.className = "muted " + (type || "");
    }

    async function checkAdmin() {
      const { data, error } = await supabase.rpc("admin_check");
      if (error) throw error;
      return !!data;
    }

    async function refreshUI() {
      setMsg(loginMsg, "");
      setMsg(applyMsg, "");
      notAdminBox.style.display = "none";

      const { data: { session } } = await supabase.auth.getSession();

      if (!session) {
        sessionInfo.textContent = "로그인 안됨";
        loginBox.style.display = "grid";
        adminBox.style.display = "none";
        btnLogout.style.display = "none";
        return;
      }

      sessionInfo.textContent = "로그인됨: " + session.user.email;
      btnLogout.style.display = "inline-block";

      try {
        const isAdmin = await checkAdmin();
        if (!isAdmin) {
          await supabase.auth.signOut();
          loginBox.style.display = "grid";
          adminBox.style.display = "none";
          notAdminBox.style.display = "block";
          notAdminMsg.textContent = "이 계정은 관리자 권한이 없습니다. (admin_users에 UID를 추가해야 함)";
          sessionInfo.textContent = "로그인 안됨";
          btnLogout.style.display = "none";
          return;
        }

        loginBox.style.display = "none";
        adminBox.style.display = "block";
      } catch (e) {
        await supabase.auth.signOut();
        loginBox.style.display = "grid";
        adminBox.style.display = "none";
        notAdminBox.style.display = "block";
        notAdminMsg.textContent = "관리자 체크 실패: " + (e?.message || e);
        sessionInfo.textContent = "로그인 안됨";
        btnLogout.style.display = "none";
      }
    }

    btnLogin.addEventListener("click", async () => {
      setMsg(loginMsg, "");
      btnLogin.disabled = true;

      try {
        const email = el("email").value.trim();
        const password = el("password").value;

        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;

        setMsg(loginMsg, "로그인 성공", "ok");
        await refreshUI();
      } catch (e) {
        setMsg(loginMsg, "로그인 실패: " + (e?.message || e), "bad");
      } finally {
        btnLogin.disabled = false;
      }
    });

    btnLogout.addEventListener("click", async () => {
      await supabase.auth.signOut();
      await refreshUI();
    });

    targetLogin.addEventListener("input", () => {
      btnApply30.disabled = targetLogin.value.trim().length === 0;
    });

    btnApply30.addEventListener("click", async () => {
      setMsg(applyMsg, "");
      btnApply30.disabled = true;

      try {
        const loginId = targetLogin.value.trim();

        // 여기 RPC 이름은 네가 만들 “아이디(text) 기준 업데이트 + expires_at 30일 연장” 함수명으로 맞춰야 함
        const { error } = await supabase.rpc("admin_set_limits_30_by_login", { p_target_login: loginId });
        if (error) throw error;

        setMsg(applyMsg, "적용 완료: " + loginId, "ok");
      } catch (e) {
        setMsg(applyMsg, "적용 실패: " + (e?.message || e), "bad");
      } finally {
        btnApply30.disabled = false;
      }
    });

    supabase.auth.onAuthStateChange(() => refreshUI());
    refreshUI();
  </script>
</body>
</html>
